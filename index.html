<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Atendimento Remoto</title>
<link rel="icon" href="data:,">
<style>
body{font-family:Arial,sans-serif;padding:12px;max-width:900px;margin:auto;}
#loginPage,#phonePage,#incomingCallModal{display:none;}
video{background:#000;border-radius:6px;width:320px;height:240px;margin:6px;}
#topBar{display:flex;justify-content:space-between;align-items:center;}
#controls{margin-top:12px;}
button,input,select{padding:6px;font-size:14px;}
#incomingCallModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:1px solid #ccc;box-shadow:0 0 10px rgba(0,0,0,0.5);}
</style>
</head>
<body>

<div id="loginPage">
  <h2>Bem-vindo</h2>
  <input id="username" placeholder="Seu nome">
  <button id="btnEnter">Entrar</button>
</div>

<div id="phonePage">
  <div id="topBar">
    <div>Logado como: <span id="myName"></span></div>
    <div>
      Usuários online: <select id="userSelect"><option>Nenhum</option></select>
      <button id="btnCall">Chamar</button>
    </div>
  </div>

  <div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div id="controls">
    <button id="btnMute">Mutar Microfone</button>
    <button id="btnHangup">Encerrar Chamada</button>
  </div>
</div>

<div id="incomingCallModal">
  <p id="incomingCallText"></p>
  <button id="acceptCall">Aceitar</button>
  <button id="rejectCall">Rejeitar</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_ring.ogg" loop></audio>

<script>
const SIGNALING_URL = "wss://snowy-shadow-3e1fteste.gerentesegurancaarn.workers.dev/";
 // coloque sua URL do Worker aqui
let ws=null,myName=null,pc=null,localStream=null,currentTarget=null,micMuted=false;

const loginPage=document.getElementById('loginPage');
const phonePage=document.getElementById('phonePage');
const usernameEl=document.getElementById('username');
const btnEnter=document.getElementById('btnEnter');
const myNameEl=document.getElementById('myName');
const localVideo=document.getElementById('localVideo');
const remoteVideo=document.getElementById('remoteVideo');
const userSelect=document.getElementById('userSelect');
const btnCall=document.getElementById('btnCall');
const btnMute=document.getElementById('btnMute');
const btnHangup=document.getElementById('btnHangup');
const incomingModal=document.getElementById('incomingCallModal');
const incomingText=document.getElementById('incomingCallText');
const acceptBtn=document.getElementById('acceptCall');
const rejectBtn=document.getElementById('rejectCall');
const ringtone=document.getElementById('ringtone');

btnEnter.onclick=async()=>{
  const name=usernameEl.value.trim();
  if(!name) return alert('Digite seu nome');
  myName=name;
  myNameEl.innerText=myName;
  loginPage.style.display='none';
  phonePage.style.display='block';
  await startPhone();
};

async function startPhone(){
  await ensureLocalStream();
  connectWS();
}

async function ensureLocalStream(){
  if(!localStream){
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject=localStream;
  }
}

function connectWS(){
  ws=new WebSocket(SIGNALING_URL);
  ws.onopen=()=>{ safeSend({type:'login', name:myName}); };
  ws.onmessage=async msg=>{
    const data=JSON.parse(msg.data);
    switch(data.type){
      case 'userlist': renderUsers(data.users); break;
      case 'call_request':
        ringtone.play();
        incomingText.innerText=`${data.from} está chamando você.`;
        incomingModal.style.display='block';
        currentTarget=data.from;
        break;
      case 'call_response':
        if(data.accept) startOffer(data.from);
        else alert(`${data.from} rejeitou a chamada`);
        break;
      case 'offer': await handleOffer(data); break;
      case 'answer': if(pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer)); break;
      case 'ice': if(pc && data.ice) await pc.addIceCandidate(data.ice); break;
    }
  };
  ws.onclose=()=>{ resetCall(); };
  ws.onerror=(e)=>{ console.log('WS erro', e); resetCall(); };
}

function safeSend(obj){ if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(obj)); }

function renderUsers(users){
  userSelect.innerHTML='';
  const others = users.filter(u=>u!==myName);
  if(!others.length){ userSelect.innerHTML='<option>Nenhum</option>'; return; }
  others.forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.text=u; userSelect.appendChild(opt); });
}

async function preparePC(){
  if(pc) return;
  pc=new RTCPeerConnection();
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=ev=>{ remoteVideo.srcObject=ev.streams[0]; }
  pc.onicecandidate=ev=>{ if(ev.candidate && currentTarget) safeSend({type:'ice', target:currentTarget, from:myName, ice:ev.candidate}); }
  pc.onconnectionstatechange=()=>{ if(['disconnected','failed','closed'].includes(pc.connectionState)) resetCall(); }
}

btnCall.onclick=()=>{
  const target=userSelect.value;
  if(!target || target==='Nenhum') return alert('Selecione um usuário');
  currentTarget=target;
  safeSend({type:'call_request', target, from:myName});
  alert('Chamando '+target);
};

async function startOffer(target){
  currentTarget=target;
  await preparePC();
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  safeSend({type:'offer', target, from:myName, offer});
}

async function handleOffer(data){
  currentTarget=data.from;
  await preparePC();
  await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  safeSend({type:'answer', target:data.from, from:myName, answer});
}

btnMute.onclick=()=>{
  if(localStream){
    localStream.getAudioTracks().forEach(t=>t.enabled=micMuted);
    micMuted=!micMuted;
    btnMute.innerText=micMuted?'Desmutar Microfone':'Mutar Microfone';
  }
};

btnHangup.onclick=()=>{ resetCall(); };

function resetCall(){
  if(pc){ try{ pc.close(); }catch(e){} pc=null; }
  remoteVideo.srcObject=null;
  currentTarget=null;
  ringtone.pause();
  ringtone.currentTime=0;
  incomingModal.style.display='none';
}

acceptBtn.onclick=()=>{
  ringtone.pause();
  ringtone.currentTime=0;
  incomingModal.style.display='none';
  safeSend({type:'call_response', target:currentTarget, from:myName, accept:true});
};

rejectBtn.onclick=()=>{
  ringtone.pause();
  ringtone.currentTime=0;
  incomingModal.style.display='none';
  safeSend({type:'call_response', target:currentTarget, from:myName, accept:false});
};

window.addEventListener('beforeunload',()=>{ if(myName) safeSend({type:'leave', name:myName}); if(ws) ws.close(); });
</script>

</body>
</html>
